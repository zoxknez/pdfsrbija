<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="sr">
<head>
	<meta charset="UTF-8" />
	<title>PDF/A-3 + UBL AF</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		body{font:16px/1.5 system-ui;margin:24px;color:#eaeaea;background:#0b0b0b}
		label{display:block;margin:8px 0 4px}
		input,button,select{font:inherit}
		input[type="file"], input[type="text"], select{
			padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#121212;color:#fff;width:100%;
		}
		button{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#1a1a1a;color:#fff;cursor:pointer}
		.row{display:flex;gap:24px;flex-wrap:wrap}
		.col{flex:1;min-width:360px}
		.card{margin-top:16px;padding:12px;background:#101010;border:1px solid #1d1d1d;border-radius:12px}
		.ok{color:#7dff9a}.bad{color:#ff6b6b}.muted{opacity:.8}
		table{width:100%;border-collapse:collapse;margin-top:8px}
		th,td{border-bottom:1px solid #222;padding:6px 8px;text-align:left}
		th{opacity:.9}
		code{background:#151515;border:1px solid #222;border-radius:6px;padding:2px 6px}
		.btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
	</style>
	<script src="/js/fetch-utils.js"></script>
	<script src="/js/csrf.js"></script>
</head>
<body>
	<h1>PDF/A-3 (B) – ugradnja UBL XML kao AF</h1>

	<div class="row">
		<div class="col">
			<div class="card">
				<label>PDF ulaz</label>
				<input id="pdf" type="file" accept="application/pdf" />

				<label style="margin-top:8px">UBL XML</label>
				<input id="ubl" type="file" accept=".xml,text/xml,application/xml" />

				<label style="margin-top:8px">Naziv priloga (opciono)</label>
				<input id="ublName" type="text" placeholder="invoice.xml" />

				<div class="btnrow">
					<button onclick="attach()">Ugradi UBL i preuzmi PDF/A-3</button>
					<button onclick="listAttachments()">Prikaži priloge</button>
					<button onclick="downloadDebug()" title="Preuzmi COS/XMP dijagnostiku za trenutni PDF">Preuzmi dijagnostiku</button>
				</div>

				<div id="attachInfo" class="muted" style="margin-top:8px"></div>
			</div>

			<div class="card">
				<h3 style="margin:0 0 8px 0">Validacija</h3>
				<label>Režim</label>
				<select id="mode">
					<option value="heuristic" selected>Heuristički (brzo)</option>
					<option value="strict">Strogo (Preflight)</option>
				</select>
				<div class="btnrow">
					<button onclick="validate()">Validiraj PDF/A</button>
					<button onclick="resetOutputs()" title="Očisti rezultate prikaza">Reset</button>
				</div>
				<div id="val" style="margin-top:10px"></div>
				<div id="errorsBox" style="margin-top:8px"></div>
				<div class="card" style="margin-top:12px;background:#0f0f0f">
					<h3 style="margin:0 0 8px 0">Saveti za PDF/A‑3</h3>
					<ul id="tips">
						<li data-code="OutputIntentMissing">Dodajte sRGB OutputIntent (ICC profil sRGB IEC61966‑2.1) u dokument.</li>
						<li data-code="XMPMissing">Osigurajte XMP metapodatke sa pdfaid:part=3 i pdfaid:conformance=B.</li>
						<li data-code="FontNotEmbedded">Ugradite sve fontove; PDF/A ne dozvoljava pozivanje sistemskih fontova.</li>
						<li data-code="FileAttachmentInvalidAF">Za UBL prilog koristite AF Relationship (npr. Alternative ili Data) i ispravan subtype.</li>
						<li>Pravila: bez enkripcije; dozvoljene anotacije su ograničene; boje moraju imati validan profil.</li>
					</ul>
				</div>
			</div>
		</div>

		<div class="col">
			<div class="card">
				<h3 style="margin:0 0 8px 0">Prilozi u PDF-u</h3>
				<div id="attachments"></div>
			</div>
		</div>
	</div>

	<script>
		function getPdfFile(){ return document.getElementById('pdf').files[0]; }
		function getUblFile(){ return document.getElementById('ubl').files[0]; }

		// Lagani, prijateljski prevod najčešćih Preflight kodova (ako nema unosa, prikazaćemo originalan kod)
		const PREFLIGHT_EXPLAIN = {
			'FontNotEmbedded': 'Font nije ugrađen. PDF/A traži ugradnju fontova da bi dokument bio samodovoljan.',
			'FontMissing': 'Nedostaje font definisan u PDF-u.',
			'FontInvalid': 'Font je oštećen ili nevažeći.',
			'InvalidColorSpace': 'Nevažeći ili nedozvoljeni color space za dati PDF/A profil.',
			'OutputIntentMissing': 'Nedostaje OutputIntent (npr. sRGB). PDF/A zahteva profil boja.',
			'InvalidICCProfile': 'ICC profil boja je nevažeći ili nepodržan.',
			'XMPMissing': 'Nedostaje XMP metapodatak koji PDF/A zahteva.',
			'XMPInvalid': 'XMP struktura nije u skladu sa PDF/A zahtevima.',
			'ForbiddenAnnotation': 'Pronađena zabranjena anotacija za dati PDF/A profil.',
			'EncryptedDocument': 'Šifrovan dokument nije dozvoljen u PDF/A.',
			'FileAttachmentInvalidAF': 'Prilog nije pravilno naveden u AF (Associated Files) strukturi.',
		};

		function explain(code){
			if (!code) return '';
			return PREFLIGHT_EXPLAIN[code] || 'Nema unapred definisanog objašnjenja. Kod: ' + code;
		}

		async function attach(){
			const pdf = getPdfFile();
			const ubl = getUblFile();
			const ublName = document.getElementById('ublName').value || 'invoice.xml';
			if(!pdf || !ubl){ alert('Odaberi PDF i UBL XML.'); return; }
			const fd = new FormData();
			fd.append('pdf', pdf);
			fd.append('ubl', ubl);
			fd.append('ublName', ublName);

			const r = await window.fetchWithCsrf('/api/pdfa3/attach', { method:'POST', body: fd });
			if(!r.ok){ alert('Greška pri generisanju.'); return; }
			const blob = await r.blob();
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = 'pdfa3-with-ubl.pdf';
			a.click();
			URL.revokeObjectURL(a.href);
			document.getElementById('attachInfo').textContent = 'Generisan i preuzet PDF/A-3 sa UBL prilogom.';
		}

		async function validate(){
			const pdf = getPdfFile();
			if(!pdf){ alert('Odaberi PDF.'); return; }
			const fd = new FormData();
			fd.append('pdf', pdf);
			const mode = document.getElementById('mode').value;
			const r = await window.fetchWithCsrf(`/api/pdfa3/validate?mode=${encodeURIComponent(mode)}`, { method:'POST', body: fd });
			const data = await r.json();

			const val = document.getElementById('val');
			const errorsBox = document.getElementById('errorsBox');
			errorsBox.innerHTML = '';

			if (data.mode === 'heuristic') {
				val.innerHTML = `<div><b>Način:</b> Heuristički</div>
												 <div><b>PDF/A validan:</b> <span class="${data.isValid?'ok':'bad'}">${data.isValid}</span></div>
												 ${data.details ? `<div class="muted">Detalji: <code>${escapeHtml(data.details)}</code></div>` : ''}`;
			} else {
				val.innerHTML = `<div><b>Način:</b> Strogi (Preflight)</div>
									 <div><b>PDF/A validan:</b> <span class="${data.isValid?'ok':'bad'}">${data.isValid}</span>
									 &nbsp; <span class="muted">Grešaka: ${data.errorCount ?? (data.errors?.length || 0)}</span></div>
									 <div class="muted" style="margin-top:6px">Napomena: Objašnjenja su indikativna; za tačan razlog pogledati kolonu Detalji.</div>`;
				if (Array.isArray(data.errors) && data.errors.length) {
					const rows = data.errors.map(e =>
						`<tr>
							<td>${escapeHtml(e.code ?? '')}</td>
							<td>${escapeHtml(explain(e.code))}</td>
							<td>${escapeHtml(e.details ?? '')}</td>
							<td>${e.page ?? ''}</td>
						</tr>`).join('');
					errorsBox.innerHTML =
						`<table>
							 <thead><tr><th>Code</th><th>Objašnjenje</th><th>Detalji</th><th>Strana</th></tr></thead>
							 <tbody>${rows}</tbody>
						 </table>`;
					// Dinamički istakni relevantne savete
					const presentCodes = new Set(data.errors.map(e => e.code).filter(Boolean));
					highlightTips(presentCodes);
				}
			}
		}

		async function downloadDebug(){
			const pdf = getPdfFile();
			if(!pdf){ alert('Odaberi PDF.'); return; }
			const fd = new FormData(); fd.append('pdf', pdf);
			const r = await window.fetchWithCsrf('/api/pdfa3/debug', { method:'POST', body: fd });
			if(!r.ok){ alert('Greška pri generisanju dijagnostike.'); return; }
			const blob = await r.blob();
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = 'pdfa3-debug.json';
			a.click();
			URL.revokeObjectURL(a.href);
		}

		async function listAttachments(){
			const pdf = getPdfFile();
			if(!pdf){ alert('Odaberi PDF.'); return; }
			const fd = new FormData();
			fd.append('pdf', pdf);
			const r = await window.fetchWithCsrf('/api/pdfa3/attachments', { method:'POST', body: fd });
			const data = await r.json();
			const el = document.getElementById('attachments');
			if (!data.attachments || !data.attachments.length) {
				el.innerHTML = '<div class="muted">Nema ugrađenih priloga.</div>';
				return;
			}
			const rows = data.attachments.map(a =>
				`<tr>
					<td>${escapeHtml(a.name ?? '')}</td>
					<td>${a.size ?? ''}</td>
					<td>${escapeHtml(a.subtype ?? '')}</td>
					<td>${escapeHtml(a.afRelationship ?? '')}</td>
				</tr>`).join('');
			el.innerHTML =
				`<div class="muted">Ukupno: ${data.count}</div>
				 <table>
					 <thead><tr><th>Naziv</th><th>Veličina</th><th>MIME/Subtype</th><th>AF</th></tr></thead>
					 <tbody>${rows}</tbody>
				 </table>`;
		}

		function escapeHtml(s){
			return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
		}

		function resetOutputs(){
			document.getElementById('attachInfo').textContent = '';
			document.getElementById('val').innerHTML = '';
			document.getElementById('errorsBox').innerHTML = '';
			document.getElementById('attachments').innerHTML = '';
			// resetuj isticanje saveta
			highlightTips(new Set());
		}

		function highlightTips(codes){
			const tips = document.querySelectorAll('#tips li[data-code]');
			tips.forEach(li => {
				const code = li.getAttribute('data-code');
				if (codes.has(code)) {
					li.style.color = '#ffd27d';
					li.style.fontWeight = '600';
				} else {
					li.style.color = '';
					li.style.fontWeight = '';
				}
			});
		}
	</script>
</body>
</html>
